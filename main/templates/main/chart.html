<div class="chart-container">
    <canvas id="combinedChart" width="1500" height="380"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let combinedChartInstance = null;

    async function fetchCombinedChartData() {
    const period = document.getElementById('periodSelect').value;
    try {
        const incomeResponse = await fetch(`/api/operations/chart/?type=income&period=${period}`);
        const expenseResponse = await fetch(`/api/operations/chart/?type=expense&period=${period}`);

        if (!incomeResponse.ok || !expenseResponse.ok) {
            throw new Error('Ошибка сети');
        }

        const incomeData = await incomeResponse.json();
        const expenseData = await expenseResponse.json();

        console.log("Income Data:", incomeData); // Лог для проверки данных доходов
        console.log("Expense Data:", expenseData); // Лог для проверки данных расходов

        return {
            labels: incomeData.labels,
            incomeData: incomeData.incomeData,
            expenseData: expenseData.expenseData
        };
    } catch (error) {
        console.error('Ошибка при загрузке данных:', error);
        return {
            labels: [],
            incomeData: [],
            expenseData: []
        };
    }
}

    async function initCombinedChart() {
    const chartData = await fetchCombinedChartData();
    console.log("Chart Data:", chartData); // Лог для проверки данных для графика
    const ctx = document.getElementById("combinedChart").getContext("2d");

    if (!chartData.incomeData.length && !chartData.expenseData.length) {
        console.warn('Нет данных для отображения на графике.');
        return;
    }

    if (combinedChartInstance) {
        combinedChartInstance.data.labels = chartData.labels;
        combinedChartInstance.data.datasets[0].data = chartData.incomeData;
        combinedChartInstance.data.datasets[1].data = chartData.expenseData;
        combinedChartInstance.update();
    } else {
        combinedChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'Доходы',
                        data: chartData.incomeData,
                        tension: 0,
                        backgroundColor: 'rgba(0, 123, 255, 0.2)',
                        borderColor: '#007bff',
                        borderWidth: 2,
                        pointBackgroundColor: '#007bff',
                        fill: true
                    },
                    {
                        label: 'Расходы',
                        data: chartData.expenseData,
                        tension: 0,
                        backgroundColor: 'rgba(255, 0, 0, 0.2)',
                        borderColor: '#ff0000',
                        borderWidth: 2,
                        pointBackgroundColor: '#ff0000',
                        fill: true
                    }
                ]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Сумма'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Дата'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: `Операции за последние ${document.getElementById('periodSelect').value} дней`
                    }
                }
            }
        });
    }
}

    document.addEventListener('DOMContentLoaded', initCombinedChart);
</script>
