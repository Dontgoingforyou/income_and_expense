<!-- Элемент canvas для графика -->
<div class="chart-container">
    <canvas id="myChart" width="900" height="380"></canvas>
</div>

<!-- График -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let myChartInstance = null;  // Глобальная переменная для Chart

    // Функция для получения данных с сервера
    async function fetchChartData() {
        const period = document.getElementById('periodSelect').value;
        try {
            const response = await fetch(`{% url 'incomes:incomes_chart_data' %}?period=${period}`, {
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                credentials: 'include'  // Включает куки для аутентификации
            });
            if (!response.ok) {
                throw new Error('Ошибка сети');
            }
            const data = await response.json();
            console.log('Полученные данные для графика:', data);  // Отладка
            return data;
        } catch (error) {
            console.error('Ошибка при загрузке данных графика:', error);
            return { labels: [], data: [] };
        }
    }

    // Функция для инициализации/обновления графика
    async function initChart() {
        console.log('Функция initChart вызвана');  // Отладка
        const chartData = await fetchChartData();
        console.log('Инициализация графика с данными:', chartData);  // Отладка

        if (!chartData.labels.length || !chartData.data.length) {
            console.warn('Нет данных для отображения на графике.');
            if (myChartInstance) {
                myChartInstance.destroy();
                myChartInstance = null;
            }
            return;
        }

        const ctx = document.getElementById("myChart").getContext("2d");

        // Если график уже существует, обновляем его
        if (myChartInstance) {
            myChartInstance.data.labels = chartData.labels;
            myChartInstance.data.datasets[0].data = chartData.data;
            myChartInstance.options.plugins.title.text = `Доходы за последние ${document.getElementById('periodSelect').value} дней`;
            myChartInstance.update();
        } else {
            // Создаём новый график
            myChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Доходы',
                        data: chartData.data,
                        tension: 0,
                        backgroundColor: 'rgba(0, 123, 255, 0.2)',
                        borderColor: '#007bff',
                        borderWidth: 2,
                        pointBackgroundColor: '#007bff',
                        fill: true
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Сумма'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Дата'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `Доходы за последние ${document.getElementById('periodSelect').value} дней`
                        }
                    }
                }
            });
        }
    }

    // Инициализируем график при загрузке страницы
    document.addEventListener('DOMContentLoaded', initChart);
</script>
